import { AXIS_KEYS, AXIS_LABELS } from "@/lib/rating/constants";

export type ReviewPromptInput = {
  title: string;
  description: string;
  hasAudio: boolean;
};

const AXIS_GUIDANCE: Record<string, string> = {
  profanity:
    "الألفاظ النابية، الشتائم، الإهانات، السب، الكلمات البذيئة أو المسيئة. يشمل التنمر اللفظي والسخرية الجارحة.",
  music:
    "وجود الموسيقى والأغاني. الموسيقى الخفيفة في الخلفية = درجة منخفضة. أغاني كاملة أو موسيقى مهيمنة = درجة عالية. الأناشيد بدون موسيقى = ٠. المؤثرات الصوتية البسيطة ليست موسيقى.",
  mixedGender:
    "الاختلاط بين الجنسين وعدم الاحتشام. يشمل: ظهور نساء بدون حجاب، مشاهد اختلاط، ملابس غير محتشمة. التفاعل المهني المحترم بدون إشكال = درجة منخفضة. ملاحظة: من الصوت فقط يمكن تقييم وجود أصوات نسائية مع رجال.",
  sexualInnuendo:
    "الإيحاءات الجنسية، التلميحات، المحتوى الرومانسي الصريح، أو أي إشارات ذات طابع جنسي ولو ضمنية.",
  drugs:
    "المخدرات، التدخين، الكحول، أو أي مواد مخدرة. يشمل الترويج لها أو تصويرها بشكل إيجابي أو محايد.",
  violence:
    "العنف الجسدي، مشاهد القتال، الدماء، الأسلحة. العنف الكرتوني الخفيف = درجة منخفضة. العنف الواقعي والدموي = درجة عالية. من الصوت: صراخ، أصوات ضرب، تأثيرات عنيفة.",
  mockingReligion:
    "الاستهزاء بالدين الإسلامي أو بأي دين، السخرية من العبادات، التشكيك في الثوابت الدينية، الإساءة للأنبياء أو الصحابة.",
  gambling:
    "القمار، الرهان، ألعاب الحظ بمقابل مادي. يشمل الترويج لمواقع المراهنات أو تصوير القمار بشكل إيجابي. فتح الصناديق العشوائية في الألعاب (loot boxes) = درجة منخفضة.",
  sensitiveIdeas:
    "أفكار حساسة مثل: الانتحار، إيذاء النفس، الاكتئاب الشديد بدون توعية، أيديولوجيات متطرفة، محتوى يثير الفتنة، مواضيع سياسية حساسة، أو أفكار تتعارض مع القيم السعودية.",
};

export function buildReviewPrompt(input: ReviewPromptInput): string {
  const axisDescriptions = AXIS_KEYS.map((key) => {
    const label = AXIS_LABELS[key];
    return `  - "${key}" (${label.ar} / ${label.en}): ${AXIS_GUIDANCE[key]}`;
  }).join("\n");

  const audioInstruction = input.hasAudio
    ? `## المقطع الصوتي

استمع بعناية للمقطع الصوتي المرفق من الفيديو. هذا هو الصوت الكامل للفيديو.
- انتبه جيداً لكل ما يُقال باللهجة السعودية والعربية الفصحى.
- استمع للموسيقى والمؤثرات الصوتية والأغاني.
- انتبه لنبرة الحديث والألفاظ المستخدمة.
- حدد المواقع الزمنية التقريبية (بالمللي ثانية) عند وجود محتوى مخالف.`
    : `## ملاحظة

لا يتوفر مقطع صوتي لهذا الفيديو. قيّم بناءً على العنوان والوصف فقط وأعطِ درجات معتدلة عند الشك.`;

  return `أنت مراجع محتوى متخصص في تقييم فيديوهات يوتيوب وفقاً للمعايير الإسلامية والثقافة السعودية.
مهمتك تقييم الفيديو التالي على ٩ محاور، كل محور بدرجة من ٠ إلى ١٠.

## معلومات الفيديو

**العنوان:** ${input.title}

**الوصف:** ${input.description || "لا يوجد وصف"}

${audioInstruction}

## محاور التقييم

لكل محور، أعطِ درجة من ٠ إلى ١٠ حسب المقياس التالي:
- ٠ = لا يوجد (لا أثر لهذا المحور في المحتوى)
- ١-٢ = نادر / خفيف جداً
- ٣-٤ = محدود (ظهور عرضي بسيط)
- ٥-٦ = متوسط (حضور ملحوظ)
- ٧-٨ = عالي (عنصر رئيسي في المحتوى)
- ٩ = شديد (مهيمن وصريح)
- ١٠ = مهيمن (المحتوى يدور حوله بالكامل)

المحاور:
${axisDescriptions}

## تعليمات مهمة

١. قيّم وفق المعايير الإسلامية والثقافة السعودية المحافظة.
٢. المحتوى موجه لتقييم مدى ملاءمته للأطفال في المملكة العربية السعودية.
٣. ${input.hasAudio ? "استمع للصوت بالكامل قبل التقييم. ركّز على اللهجة السعودية والمحتوى المنطوق." : "قيّم بحذر أكبر بناءً على ما هو متاح (العنوان والوصف) وأعطِ درجات معتدلة عند الشك."}
٤. لكل محور حصل على درجة ١ أو أعلى، قدّم دليلاً مختصراً يوضّح سبب التقييم.
٥. الدليل يجب أن يكون نصاً عربياً مختصراً (جملة أو جملتين).
٦. إذا وجدت جزءاً محدداً يدعم تقييمك، حدد موقعه الزمني التقريبي بالمللي ثانية.

## تنسيق الإجابة

أجب بصيغة JSON فقط بدون أي نص إضافي، وفق الهيكل التالي:

{
  "scores": {
    "profanity": 0,
    "music": 0,
    "mixedGender": 0,
    "sexualInnuendo": 0,
    "drugs": 0,
    "violence": 0,
    "mockingReligion": 0,
    "gambling": 0,
    "sensitiveIdeas": 0
  },
  "evidence": [
    {
      "axisKey": "profanity",
      "note": "سبب التقييم باللغة العربية",
      "approximateOffsetMs": null
    }
  ],
  "summary": "ملخص عام مختصر عن مدى ملاءمة المحتوى للأطفال"
}

أجب بـ JSON فقط.`;
}
