generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ──────────────────────────────────────────

enum AgeRating {
  G
  PG
  PG12
  PG15
  R15
  R18
}

enum Confidence {
  HIGH
  MEDIUM
  LOW
}

enum RatingStatus {
  UNSCANNED
  SCANNED
}

enum SubmissionStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ReportStatus {
  PENDING
  REVIEWED
  DISMISSED
}

enum ReviewItemType {
  SUBMISSION
  REPORT
}

enum ReviewItemStatus {
  PENDING
  APPROVED
  REJECTED
  DISMISSED
}

enum ClientType {
  ADMIN_MANUAL
  WEB_TAB_CAPTURE
  EXTENSION
  AI_GEMINI
}

// ─── Models ─────────────────────────────────────────

model Channel {
  id               String   @id @default(cuid())
  youtubeChannelId String   @unique
  name             String
  nameAr           String?
  thumbnailUrl     String?
  teamTag          String?
  subscriberCount  Int?
  videoCount       Int?
  lastImportedAt   DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  videos Video[]

  @@index([teamTag])
}

model Video {
  id              String   @id @default(cuid())
  youtubeVideoId  String   @unique
  channelId       String?
  title           String
  description     String?
  publishedAt     DateTime?
  durationSec     Int?
  thumbnails      Json?
  viewCount       Int?
  lastFetchedAt   DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  channel         Channel?         @relation(fields: [channelId], references: [id], onDelete: SetNull)
  ratingAggregate RatingAggregate?
  scanRuns        ScanRun[]
  reports         Report[]

  @@index([channelId])
  @@index([publishedAt(sort: Desc)])
}

model RatingAggregate {
  id              String       @id @default(cuid())
  videoId         String       @unique
  ageRating       AgeRating
  confidence      Confidence   @default(LOW)
  scores          Json         // { profanity: 0, music: 0, ... }
  evidencePreview Json?        // [{ axisKey, startMs, endMs, note }]
  scansCount      Int          @default(1)
  status          RatingStatus @default(SCANNED)
  rubricVersion   Int          @default(1)
  lastUpdatedAt   DateTime     @default(now())
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  video   Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  reports Report[]
}

model ScanRun {
  id             String     @id @default(cuid())
  videoId        String
  clientType     ClientType @default(ADMIN_MANUAL)
  qualityMetrics Json?
  deviceHash     String?
  createdAt      DateTime   @default(now())

  video    Video          @relation(fields: [videoId], references: [id], onDelete: Cascade)
  evidence ScanEvidence[]

  @@index([videoId])
}

model ScanEvidence {
  id        String @id @default(cuid())
  scanRunId String
  axisKey   String
  startMs   Int?
  endMs     Int?
  note      String

  scanRun ScanRun @relation(fields: [scanRunId], references: [id], onDelete: Cascade)

  @@index([scanRunId])
}

model Submission {
  id        String           @id @default(cuid())
  videoUrl  String
  note      String?
  status    SubmissionStatus @default(PENDING)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  reviewItem ReviewQueue?
}

model Report {
  id        String       @id @default(cuid())
  videoId   String
  ratingId  String?
  category  String
  message   String?
  status    ReportStatus @default(PENDING)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  video           Video            @relation(fields: [videoId], references: [id], onDelete: Cascade)
  ratingAggregate RatingAggregate? @relation(fields: [ratingId], references: [id], onDelete: SetNull)
  reviewItem      ReviewQueue?
}

model ReviewQueue {
  id           String           @id @default(cuid())
  itemType     ReviewItemType
  submissionId String?          @unique
  reportId     String?          @unique
  status       ReviewItemStatus @default(PENDING)
  reviewerNote String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  submission Submission? @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  report     Report?     @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([itemType])
}

model QuotaLog {
  id        String   @id @default(cuid())
  date      DateTime @db.Date
  endpoint  String
  unitsCost Int
  createdAt DateTime @default(now())

  @@index([date])
}
